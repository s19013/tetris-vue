# 動きにちょっと癖があるテトリス
[実物](s19013.github.io/tetris-vue/)  
パソコン推奨  
ブラウザで動作するのでインストールは不要です｡

## 注意
**ガチりたい人は既製品を買いましょう!**  
公式といろいろ違う  
一部意図しない動きがあります｡  
一部回し入れの仕方が公式と異なる

## 操作
|||
|--|--|
|WASDもしくは矢印キー|移動|
|J|左回転|
|L|右回転|
|Space|ホールド|

# 実装した機能
* 最低限の基礎
* ホールド
* 規則性のあるnext
* ハードドロップ
* お邪魔ブロック
* ゴースト
* 一部の回し入れ
* tスピン判定
* back to back判定
* パーフェクトクリア

## デモ
### おじゃまブロック
一定時間時間が立つ事におじゃまブロックがせり上がってくる
<iframe src="https://drive.google.com/file/d/1ZjfBHeWJCpfLSLj-wM4UfdpD4zJ4-cBn/preview" width="320" height="240" allow="autoplay"></iframe>

### 回し入れ,tスピン判定,back to back判定
<iframe src="https://drive.google.com/file/d/1c6USJyKeyRn4Tj4mjN8BC9UwdwtRDO3D/preview" width="320" height="240" allow="autoplay"></iframe>

# 目的や動機
とりあえず自力だけで1から作ってみたかった｡  
~~コードを書いているときは､他人のテトリスのコードは見なかった｡(意図的)~~  
Tスピン判定とスコア計算は[他のサイト](https://www.terasol.co.jp/%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0/6729)を参考にした｡  
それ以外はできるだけ自分で考えた｡  

# 使った技術
* javascript
* vue

# 開発に使ってたメモたち
当時何考えてたかしることができるかもしれない?

### 時系列何してたか?
#### 2023/06~2023/07
* 最低限の基礎
* ホールド
* 規則性のあるnext
* ハードドロップ
* お邪魔ブロック
* ゴースト
* 一部の回し入れ

#### 2023/12の末~2024/01
コードのリファクタリングや修正

#### 2024/02
* tスピン判定
* back to back判定
* パーフェクトクリア

# 苦労したとこ
## 回転系
このコードで一番大変だった  
これが本当にエラーの連続｡  
そもそもどうやって回すのかわかるまで時間かかったし｡  
その後ぶつかるブロックをどうするかが分からなかった｡  
三角関数を勉強しなおした｡  
思いついた方法を片っ端から試していったり､頭の中にある考えをひたすら紙に書き出すなどした｡  
一見成功したかに見えるコードでも､別のパターンだと想定外の動きをして結局作り直したりした｡  
一難去ってまた一難の連続だった  
Iミノの癖が強い  
1週間近くはかかってしまった｡  

## jsの仕様にふりまわされた｡
### 浅いコピー
ところどころ浅いコピーをしてしまって予定通りの動きをしなかった｡そして浅いコピーが原因だと気づくのに時間がかかった  
### trycatchの使い方
tryCatchを使ったのは良いが｡catchのエラーを出力していなかったため｢どうしてエラーがでないの?｣｢どうしてうごかないの?｣  
などと気づくのに時間がかかった｡
### オブジェクトの仕様
とある処理をしていたときに､本来最後まで値が変わらないはずの定数の値が処理の途中で勝手に変化していた｡
その原因となる場所を特定するのに時間がかかってしまった｡
しかし､なぜ変化するかは調べてもわからないためchatGPTに質問した｡
`JavaScriptでは、オブジェクトや配列などの複合型の変数は参照渡しであり、関数内でその中身を変更すると元の変数も変更されることがあります。`
とのことなので､影響がありそうな場所は全部コピーして渡すことにした｡

# 反省
リファクタリングもっと計算だててやるべきだった｡  
勢いでやってしまった｡  
ctrl + F で修正するのではなく F2を使って変数を書き直したほうがよりバグが出にくかったかもしれない｡  
`どこどこに影響が出るから修正しないと行けない`というリストというか計画書を作ってから修正に取り組むべきだった｡  

# リファクタリング?
最初は`Tetris.js`に大半のコードがあった(682行)それを､関数を作って動作をまとめたり､別ファイルに書き出したり､個別にインスタンス化するなどをすることによって､今は390行に減った｡(2024/02時点)  
[ver1](https://github.com/s19013/tetris-vue/tree/ver1.0)のブランチとmainブランチを見比べれば元がどれだけ悲惨だったかなんとなくわかると思います｡  

回し入れの処理は最初期は自分で見返しても全くわからないほどのスパゲッティコードだった｡  
なので一から考え直して自分でも理解ができる説明ができるような単純なコードに修正  

例えば以下のようなことをした  
* フィールドに関すること -> Field.jsに書き出し
* ホールド機能に関すること -> Hold.jsに書き出し
* テトリミノに関すること -> 個別にTetriminoクラスを作成
* コールバックを使って似たような処理をまとめた｡
* フィールド､ゴースト､テトリミノをレイヤー別に表示させることによって｡Field.statusの配列の中身をbooleanだけにした｡

他にも細かいことを色々と｡

# 今後
typescriptの練習としてtypescriptに書き換える  
ラッキーアタックを実装  
このゲームのロジックなどを活かして次はぷよぷよを作りたい  


# 参考にした
* https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce
* https://www.javadrive.jp/javascript/array/index10.html
* https://codelikes.com/javascript-throw/
* https://pisuke-code.com/js-correct-way-of-array-copy/
* https://www.freecodecamp.org/japanese/news/how-to-clone-an-array-in-javascript-1d3183468f6a/
* https://pisuke-code.com/js-examples-of-array-reduce-usage/
* https://www.terasol.co.jp/%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%9f%e3%83%b3%e3%82%b0/6729
* 良いコード悪いコード
